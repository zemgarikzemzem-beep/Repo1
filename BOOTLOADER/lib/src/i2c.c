#include "i2c.h"

//#define I2C_DMA

#ifndef I2C_DMA
void I2C1_Init(void){
	RCC->APB1ENR|=RCC_APB1ENR_I2C1EN;
	RCC->CFGR3|=RCC_CFGR3_I2C1SW_SYSCLK;
	
	GPIOB->MODER&=~(GPIO_MODER_MODER6|GPIO_MODER_MODER7);
	GPIOB->MODER|=(GPIO_MODER_MODER6_1|GPIO_MODER_MODER7_1);
	GPIOB->OTYPER|=(GPIO_OTYPER_OT_6|GPIO_OTYPER_OT_7);
	GPIOB->OSPEEDR|=(GPIO_OSPEEDER_OSPEEDR6|GPIO_OSPEEDER_OSPEEDR7);
	GPIOB->AFR[0]|=((1<<GPIO_AFRL_AFSEL6_Pos)|(1<<GPIO_AFRL_AFSEL7_Pos));
	
	I2C1->CR1=0;
	//I2C1->CR2=0;
	I2C1->CR2=(I2C_CR2_AUTOEND|I2C_CR2_NACK); // 
	I2C1->OAR1=I2C_OAR1_OA1EN;
	I2C1->TIMINGR=(uint32_t)0x20000209; // 0xB0420F13 0x0000020B 0x00B00000 0x00B01A4B
	I2C1->CR1|=I2C_CR1_PE;
}

void I2C1_SendByte (uint8_t b){
	while(I2C1->ISR&I2C_ISR_BUSY); // !(I2C1->ISR&I2C_ISR_TXE)
	I2C1->TXDR = b;
	I2C1->CR2|=I2C_CR2_START;
}
#else
void I2C1_Init_DMA(void){
	RCC->APB1ENR|=RCC_APB1ENR_I2C1EN;
	RCC->AHBENR|=RCC_AHBENR_DMA1EN;
	
	GPIOB->MODER&=~(GPIO_MODER_MODER6|GPIO_MODER_MODER7);
	GPIOB->MODER|=(GPIO_MODER_MODER6_1|GPIO_MODER_MODER7_1);
	GPIOB->OSPEEDR|=(GPIO_OSPEEDER_OSPEEDR6|GPIO_OSPEEDER_OSPEEDR7);
	GPIOB->AFR[0]|=((1<<GPIO_AFRL_AFSEL6_Pos)|(1<<GPIO_AFRL_AFSEL7_Pos));
	
	I2C1->CR1=0;
	I2C1->CR2=0;
	I2C1->CR2|=(I2C_CR2_AUTOEND|(0x4E<<(I2C_CR2_SADD_Pos))|(1<<I2C_CR2_NBYTES_Pos)); // 0x4E = addr<<1
//	I2C1->OAR1=I2C_OAR1_OA1EN;
	I2C1->TIMINGR=(uint32_t)0x00B01A4B;
	
	I2C1->CR1|=I2C_CR1_TXDMAEN;
	I2C1->CR1|=I2C_CR1_PE;
	
	DMA1_Channel2->CCR=0;
	DMA1_Channel2->CCR|=(DMA_CCR_MINC|DMA_CCR_DIR); // |DMA_CCR_PSIZE_0|DMA_CCR_MSIZE_0
	DMA1_Channel2->CPAR=(uint32_t)(&I2C1->TXDR);
	//DMA1_CSELR->CSELR=(0b0011<<DMA_CSELR_C6S_Pos);
}

void I2C1_Send_DMA(uint8_t* data, uint16_t len){
	
	DMA1_Channel2->CCR&=~DMA_CCR_EN;
	DMA1_Channel2->CMAR=(uint32_t)data;
	DMA1_Channel2->CNDTR=len;
	DMA1_Channel2->CCR|=DMA_CCR_EN;
	
	I2C1->CR2|=I2C_CR2_START;
	while(I2C1->ISR&I2C_ISR_BUSY);
}
#endif //I2C_DMA
